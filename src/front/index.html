<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Calcul des Points Staking</title>
</head>
<body>

    <h1>Dashboard Kiln Vaults</h1>

    <div class="form">
        <div class="wallet">
            <svg width="40" height="35" viewBox="0 0 40 35" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M5.24902 34.2651H30.8838C34.2896 34.2651 36.1389 32.4158 36.1389 29.0466V25.2136H32.5134V28.6316C32.5134 30.0049 31.8115 30.6396 30.5237 30.6396H5.60913C4.31519 30.6396 3.62549 30.0049 3.62549 28.6316V13.1165C3.62549 11.7493 4.31519 11.1023 5.60913 11.1023H30.5237C31.8115 11.1023 32.5134 11.7493 32.5134 13.1165V16.0522H36.1389V12.7014C36.1389 9.33228 34.2896 7.48901 30.8838 7.48901H14.5691C14.2029 7.48901 14.1663 7.13501 14.5508 7.03125L25.2686 4.01611C26.6174 3.63159 27.4597 4.18701 27.4597 5.49316V9.30176L30.8716 9.17358V5.76782C30.8716 1.83716 28.0518 -0.0915488 23.5168 1.36719L3.77808 7.48901C1.25732 8.29468 0 9.8877 0 12.7014V29.0466C0 32.4219 1.86157 34.2651 5.24902 34.2651ZM29.5654 22.6196C30.5237 22.6196 31.3171 21.8323 31.3171 20.8557C31.3171 19.8853 30.5237 19.0979 29.5654 19.0979C28.5828 19.0979 27.7954 19.8853 27.7954 20.8557C27.7954 21.8323 28.5828 22.6196 29.5654 22.6196ZM29.6143 26.5259H35.6506C37.9517 26.5259 39.27 25.0427 39.27 22.8638V18.866C39.27 16.6931 37.9517 15.2039 35.6506 15.2039H29.6143C25.8972 15.2039 23.4619 17.157 23.4619 20.8618C23.4619 24.5667 25.8972 26.5259 29.6143 26.5259ZM29.6387 23.8098C27.5391 23.8098 26.2939 22.76 26.2939 20.8618C26.2939 18.9636 27.5391 17.9138 29.6387 17.9138H35.0159C36.0413 17.9138 36.5601 18.4326 36.5601 19.458V22.2717C36.5601 23.291 36.0413 23.8098 35.0159 23.8098H29.6387Z" fill="white" fill-opacity="0.85"/>
            </svg>

            <input type="text" id="wallet" placeholder="Entrez votre wallet">
        </div>
        
        <div class="vault">
            <div class="blockchain-container">
                <svg width="35" height="35" viewBox="0 0 35 35" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18.2083 10.3508L15.5655 12.9936C17.2928 13.1401 18.6539 13.7321 19.5816 14.666C22.1817 17.2661 22.1878 20.916 19.5938 23.5039L14.2654 28.8261C11.6653 31.4201 8.02765 31.4262 5.43366 28.8322C2.82746 26.226 2.83356 22.5761 5.42145 19.9944L7.80182 17.6079C7.26471 16.3567 7.03888 14.7392 7.43561 13.3354L2.96173 17.7849C-0.987241 21.7033 -0.993344 27.3125 2.98004 31.2798C6.95343 35.2592 12.5443 35.2287 16.4749 31.2981L22.0535 25.7195C25.9903 21.7766 26.0086 16.1858 22.0413 12.2185C21.1563 11.3396 19.8868 10.6316 18.2083 10.3508ZM16.0477 23.9067L18.6844 21.2578C16.9632 21.1174 15.6021 20.5193 14.6744 19.5854C12.0743 16.9914 12.0682 13.3354 14.6622 10.7536L19.9905 5.43137C22.5906 2.83737 26.2283 2.83127 28.8223 5.41916C31.4285 8.03146 31.4224 11.6753 28.8345 14.2571L26.4542 16.6435C26.9913 17.9008 27.2171 19.5122 26.8204 20.9221L31.2943 16.4726C35.2432 12.5542 35.2432 6.94504 31.2759 2.97775C27.2964 -1.00174 21.7117 -0.977324 17.7811 2.95944L12.2025 8.53806C8.26569 12.4687 8.24738 18.0717 12.2147 22.039C13.0997 22.9179 14.3631 23.6198 16.0477 23.9067Z" fill="white" fill-opacity="0.85"/>
                </svg>
                
                <select id="blockchain">
                    <option value="eth">Ethereum</option>
                    <option value="arb">Arbitrum</option>
                    <option value="bsc">Binance Smart Chain</option>
                    <option value="matic">Polygon</option>
                    <option value="op">Optimism</option>
                </select>
            </div>
            
            <div class="vault-container">
                <svg width="70" height="33" viewBox="0 0 27 33" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M15.2466 0.823975C16.864 1.34888 22.3145 3.23486 23.9929 3.92456C25.8301 4.6875 26.5381 5.52368 26.5381 7.61719V19.1589C26.5381 24.7253 23.4802 27.2156 14.4104 31.8542C14.0076 32.0557 13.5864 32.1899 13.269 32.1899C12.9517 32.1899 12.5183 32.0618 12.1216 31.8542C3.15552 27.0508 0 24.7253 0 19.1589V7.61719C0 5.52368 0.708008 4.67529 2.53906 3.92456C4.22363 3.24097 9.66797 1.33667 11.2854 0.823975C11.908 0.640869 12.6465 0.500488 13.269 0.500488C13.8855 0.500488 14.624 0.634766 15.2466 0.823975ZM8.76465 11.9568V13.739C7.87354 13.8611 7.42188 14.447 7.42188 15.5579V21.8384C7.42188 23.1384 8.00171 23.7244 9.198 23.7244H17.3645C18.5547 23.7244 19.1284 23.1384 19.1284 21.8384V15.5579C19.1284 14.447 18.6829 13.8611 17.7979 13.7451V11.9568C17.7979 8.94775 15.9729 6.9397 13.2812 6.9397C10.5835 6.9397 8.76465 8.94775 8.76465 11.9568ZM15.6677 11.8164V13.6841H10.8826V11.8164C10.8826 10.1257 11.8286 9.00879 13.269 9.00879C14.7156 9.00879 15.6677 10.1196 15.6677 11.8164Z" fill="white" fill-opacity="0.85"/>
                </svg>
                
                <input type="text" id="vault" placeholder="Entrez l'adresse du vault">
            </div>
            
        </div>
        
        <button onclick="fetchPoints()">Vérifier</button>
    </div>
    

    <div id="result"></div>

    <script>
        async function fetchPoints() {
            const wallet = document.getElementById("wallet").value;
            const vault = document.getElementById("vault").value;
            const blockchain = document.getElementById("blockchain").value;

            if (!wallet) {
                alert("Veuillez entrer une adresse de wallet.");
                return;
            }
            if (!vault) {
                alert("Veuillez entrer une adresse de vault.");
                return;
            }

            const formattedVault = `${blockchain}_${vault}`;
            const apiUrl = `http://127.0.0.1:5000/points?wallet=${wallet}&vault=${formattedVault}`;

            document.getElementById("result").innerHTML = "Chargement...";

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (!data.success) {
                    document.getElementById("result").innerHTML = `<p style="color: red;">Erreur : ${data.message}</p>`;
                    return;
                }

                let html = `<h2>Total des points: ${data.points.toLocaleString()}</h2>`;
                html += `<table>
                    <tr>
                        <th>Période</th>
                        <th>Temps écoulé (jours)</th>
                        <th>TVL</th>
                        <th>Points calculés</th>
                    </tr>`;

                let lastEvent = data.events[0]; 
                let depositCount = 0;
                let withdrawCount = 0;

                for (let i = 1; i < data.events.length; i++) {
                    const currentEvent = data.events[i];

                    // Calcul du temps écoulé entre deux événements
                    const timeElapsed = (
                        (new Date(currentEvent.timestamp) - new Date(lastEvent.timestamp)) /
                        (1000 * 60 * 60 * 24)
                    ).toFixed(2);

                    let lastLabel = lastEvent.type === "deposit" ? `Dépôt ${++depositCount}` : `Retrait ${++withdrawCount}`;
                    let currentLabel = currentEvent.type === "deposit" ? `Dépôt ${depositCount + 1}` : `Retrait ${withdrawCount + 1}`;

                    html += `
                        <tr>
                            <td>${lastLabel} → ${currentLabel}</td>
                            <td>${timeElapsed} jours</td>
                            <td>${lastEvent.TVL_after_event.toLocaleString()}</td>
                            <td>${(currentEvent.cumulative_points - lastEvent.cumulative_points).toLocaleString()}</td>
                        </tr>`;

                    lastEvent = currentEvent;
                }

                const now = new Date();
                const lastTimestampDate = new Date(lastEvent.timestamp);
                const daysSinceLast = ((now - lastTimestampDate) / (1000 * 60 * 60 * 24)).toFixed(2);

                html += `
                    <tr>
                        <td>${lastEvent.type === "deposit" ? `Dépôt ${depositCount + 1}` : `Retrait ${withdrawCount + 1}`} → Maintenant</td>
                        <td>${daysSinceLast} jours</td>
                        <td>${lastEvent.TVL_after_event.toLocaleString()}</td>
                        <td>${data.points.toLocaleString()}</td>
                    </tr>`;

                html += `
                    <tr>
                        <td colspan="3" style="text-align: right; font-weight: bold;">Total des points</td>
                        <td style="background: black; font-weight: bold;">${data.points.toLocaleString()}</td>
                    </tr>
                </table>`;


                const rewards = data.total_rewards;
                html += `
                    <h2>Rewards</h2>
                    <table>
                        <tr>
                            <th>Montant des rewards </th>
                        </tr>
                        <tr>
                            <td class="reward">${rewards}</td>
                `;

                document.getElementById("result").innerHTML = html;

            } catch (error) {
                document.getElementById("result").innerHTML = `<p style="color: red;">Erreur lors de la récupération des données.</p>`;
                console.error("Erreur API :", error);
            }
        }

    </script>

</body>
</html>
